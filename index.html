<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Permainan Rama-rama</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #e0f7fa;
      font-family: Arial, sans-serif;
    }
    #startScreen, #gameOverText {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    #startScreen button {
      margin: 10px;
      padding: 12px 24px;
      font-size: 20px;
      border: none;
      border-radius: 8px;
      background-color: #00c853;
      color: white;
      cursor: pointer;
    }
    #startScreen button:hover {
      background-color: #00b342;
    }
    .obj {
      position: absolute;
      width: 64px;
      height: 64px;
      background-image: url('butterfly.png');
      background-size: cover;
      display: none;
    }
    #pointerImg {
      position: absolute;
      width: 48px;
      height: 48px;
      background: url('pointer.png') no-repeat center center;
      background-size: contain;
      pointer-events: none;
      display: none;
    }
    #pointerLabel {
      position: absolute;
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 2px 5px;
      font-size: 12px;
      display: none;
    }
    #hud {
      position: absolute;
      top: 10px;
      left: 10px;
      color: black;
      font-size: 20px;
      z-index: 5;
    }
    #hitEffect {
      position: absolute;
      width: 80px;
      height: 80px;
      background: url('explosion.gif') no-repeat center center;
      background-size: contain;
      display: none;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="startScreen">
    <h1>Permainan Rama-rama</h1>
    <p>ðŸš€ Gunakan pergerakan tangan Anda untuk mengontrol pointer!</p>
    <p>ðŸ‘‹ Tunjukkan tangan Anda ke kamera dan gerakkan untuk menggerakkan pointer</p>
    <p>ðŸŽ¯ Sentuh rama-rama untuk mendapatkan poin</p>
    <p>ðŸ’¡ Pastikan pencahayaan cukup dan tangan terlihat jelas di kamera</p>
    <div>
      <button onclick="startLevel(1)">Level 1</button>
      <button onclick="startLevel(2)">Level 2</button>
      <button onclick="startLevel(3)">Level 3</button>
    </div>
  </div>

  <div id="hud">
    <div>Skor: <span id="score">0</span></div>
    <div>Masa: <span id="time">0</span>s</div>
  </div>

  <div id="pointerImg"></div>
  <div id="pointerLabel"></div>
  <div class="obj"></div>
  <div id="hitEffect"></div>
  <div id="gameOverText"></div>

  <audio id="popSound" src="pop.mp3"></audio>
  <audio id="bgMusic" src="background.mp3" loop></audio>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script>
    const startScreen = document.getElementById('startScreen');
    const pointerImg = document.getElementById('pointerImg');
    const pointerLabel = document.getElementById('pointerLabel');
    const butterflies = document.querySelectorAll('.obj');
    const scoreDisplay = document.getElementById('score');
    const timeDisplay = document.getElementById('time');
    const gameOverText = document.getElementById('gameOverText');
    const hitEffect = document.getElementById('hitEffect');
    const popSound = document.getElementById('popSound');
    const bgMusic = document.getElementById('bgMusic');

    let score = 0;
    let timeLeft = 0;
    let countdown;
    let gameActive = false;
    let level = 1;

    function startLevel(levelNumber) {
      level = levelNumber;
      startScreen.style.display = 'none';
      score = 0;
      timeLeft = 0;
      scoreDisplay.textContent = score;
      timeDisplay.textContent = timeLeft;
      gameOverText.style.display = 'none';
      gameActive = true;
      bgMusic.currentTime = 0;
      bgMusic.play();
      pointerImg.style.display = 'block';
      pointerLabel.style.display = 'block';

      if (level === 1) startLevel1();
      else if (level === 2) startLevel2();
      else if (level === 3) startLevel3();
    }

    function startLevel1() {
      countdown = setInterval(() => {
        if (!gameActive) return;
        timeLeft++;
        timeDisplay.textContent = timeLeft;
        if (timeLeft >= 180) endGame("Masa tamat!");
      }, 1000);
      showSingleButterfly();
    }

    function showSingleButterfly() {
      const b = butterflies[0];
      const x = Math.random() * (window.innerWidth - 64);
      const y = Math.random() * (window.innerHeight - 64);
      b.style.left = `${x}px`;
      b.style.top = `${y}px`;
      b.style.display = 'block';
      b.dataset.active = 'true';
    }

    function startLevel2() {
      countdown = setInterval(() => {
        if (!gameActive) return;
        timeLeft++;
        timeDisplay.textContent = timeLeft;
        if (timeLeft >= 180) endGame("Masa tamat!");
      }, 1000);
      spawnButterflyLevel2();
    }

    function spawnButterflyLevel2() {
      if (!gameActive) return;
      const b = butterflies[0];
      const x = Math.random() * (window.innerWidth - 64);
      const y = Math.random() * (window.innerHeight - 64);
      b.style.left = `${x}px`;
      b.style.top = `${y}px`;
      b.style.display = 'block';
      b.dataset.active = 'true';
      setTimeout(() => {
        if (b.dataset.active === 'true') {
          b.style.display = 'none';
          b.dataset.active = 'false';
          spawnButterflyLevel2();
        }
      }, 2000);
    }

    function startLevel3() {
      countdown = setInterval(() => {
        if (!gameActive) return;
        timeLeft++;
        timeDisplay.textContent = timeLeft;
        if (timeLeft >= 180) endGame("Masa tamat!");
      }, 1000);
      spawnButterflyLevel3();
    }

    function spawnButterflyLevel3() {
      if (!gameActive) return;
      const b = butterflies[0];
      const x = Math.random() * (window.innerWidth - 64);
      const y = Math.random() * (window.innerHeight - 64);
      b.style.left = `${x}px`;
      b.style.top = `${y}px`;
      b.style.display = 'block';
      b.dataset.active = 'true';

      let dx = (Math.random() - 0.5) * 2;
      let dy = (Math.random() - 0.5) * 2;

      const moveInterval = setInterval(() => {
        if (!gameActive || b.dataset.active !== 'true') {
          clearInterval(moveInterval);
          return;
        }
        let currentX = parseFloat(b.style.left);
        let currentY = parseFloat(b.style.top);
        currentX += dx;
        currentY += dy;
        if (currentX < 0 || currentX > window.innerWidth - 64) dx = -dx;
        if (currentY < 0 || currentY > window.innerHeight - 64) dy = -dy;
        b.style.left = `${currentX}px`;
        b.style.top = `${currentY}px`;
      }, 20);
    }

    function endGame(message) {
      clearInterval(countdown);
      gameOverText.textContent = message;
      gameOverText.style.display = 'flex';
      gameActive = false;
      bgMusic.pause();
      setTimeout(() => {
        startScreen.style.display = 'flex';
        pointerImg.style.display = 'none';
        pointerLabel.style.display = 'none';
        butterflies.forEach(b => {
          b.style.display = 'none';
          b.dataset.active = 'false';
        });
      }, 3000);
    }

    const hands = new Hands({locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7 });

    const videoElement = document.createElement('video');
    videoElement.style.display = 'none';
    document.body.appendChild(videoElement);

    const camera = new Camera(videoElement, {
      onFrame: async () => { await hands.send({image: videoElement}); },
      width: 640,
      height: 480
    });
    camera.start();

    hands.onResults(results => {
      if (!gameActive || !results.multiHandLandmarks.length) return;
      const landmark = results.multiHandLandmarks[0][0];
      const x = (1 - landmark.x) * window.innerWidth;
      const y = landmark.y * window.innerHeight;
      pointerImg.style.left = `${x - 24}px`;
      pointerImg.style.top = `${y - 24}px`;
      pointerLabel.style.left = `${x + 10}px`;
      pointerLabel.style.top = `${y + 10}px`;
      pointerLabel.textContent = `x: ${Math.round(x)} y: ${Math.round(y)}`;

      butterflies.forEach(b => {
        if (b.dataset.active !== 'true') return;
        const rect = b.getBoundingClientRect();
        const dx = x - (rect.left + rect.width / 2);
        const dy = y - (rect.top + rect.height / 2);
        const distance = Math.hypot(dx, dy);
        if (distance < 50) {
          b.dataset.active = 'false';
          b.style.display = 'none';
          score++;
          scoreDisplay.textContent = score;
          popSound.currentTime = 0;
          popSound.play();
          hitEffect.style.left = `${x - 40}px`;
          hitEffect.style.top = `${y - 40}px`;
          hitEffect.style.display = 'block';
          setTimeout(() => hitEffect.style.display = 'none', 500);

          if (score >= 10) endGame("TAHNIAH. Anda berjaya!");
          else {
            if (level === 1) showSingleButterfly();
            else if (level === 2) spawnButterflyLevel2();
            else if (level === 3) spawnButterflyLevel3();
          }
        }
      });
    });
  </script>
</body>
</html>
